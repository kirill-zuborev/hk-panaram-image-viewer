<link rel="import" href="../polymer/polymer-element.html">

<script type="text/javascript" src="lib/pannellum.js"></script>

<dom-module id="hk-panoram-image-viewer">
	<link rel="import" type="css" href="lib/pannellum.css" />

	<template>
		<style>
			:host {
				display: block;
			}

			#panorama {
				width: 100%;
				height: 100%;
			}
		</style>
		<div id="panorama"></div>

	</template>

	<script>
		/**
		 * `hk-panoram-image-viewer`
		 * Image viewer for 360 degree photos
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class HkPanoramImageViewer extends Polymer.Element {
			static get is() { return 'hk-panoram-image-viewer'; }
			static get properties() {
				return {
					imageUrl: String,
					_currentScene: {
						type: Object,
						value: null
					}
				};
			}

			static get observers() {
				return [
					'_imageUrlChanged(imageUrl)'
				];
			}

			_imageUrlChanged(imageUrl) {
				if (this._currentScene) {
					const gr = this._currentScene.getRenderer();

					if (gr) {
						const gc = gr.getCanvas();
						const gl = gc.getContext("webgl");
	
						if (gl) {
							gl.getExtension('WEBGL_lose_context').loseContext();
						}
					}

					this._currentScene.destroy();
					this._currentScene = null;

					const panorama = this.shadowRoot.querySelector("#panorama");
					while (panorama.firstChild) {
						panorama.removeChild(panorama.lastChild);
					}
				}

				if (imageUrl) {
					this._currentScene = pannellum.viewer(this.shadowRoot.querySelector("#panorama"), {
						"type": "equirectangular",
						"panorama": imageUrl,
						"autoLoad": true,
						"showFullscreenCtrl": false
					});
				}
			}
		}

		window.customElements.define(HkPanoramImageViewer.is, HkPanoramImageViewer);
	</script>
</dom-module>